##
## There are three levels on which the feature is verified:
##
## * on X Protocol layer (without decompressing)
## * confirming that resultset flow is correct
## * confirming that resultset contains correct data
##
## Test that verifies flow of SQL execution through X Protocol-prepare-statement
## (bullet no 2)


## Preamble
--source include/xplugin_preamble.inc
--source include/xplugin_create_user.inc
## Test starts here

--source ../include/test_flow_resultset_prepexecute_sql.inc

##
## Please take a note that this test (and others) use following terms:
## SINGLE, MULTIPLE, GROUP
##
## Those correspond to concrete setting of compression capabilities:
## server_combine_mixed_messages, server_max_combine_messages and
## describe only compressed messages generated by the server.
##
## * SINGLE - it corresponds to
##            server_combine_mixed_messages=TRUE|FALSE,
##            server_max_combine_messages=1
##            In this configuration exact one X Protocol message is
##            encapsulated in one Mysqlx.Connection.Compression
##
## * MULTIPLE - it corresponds to
##              server_combine_mixed_messages=FALSE,
##              server_max_combine_messages=UNSET|0
##              In this configuration multiple X Protocol messages
##              of the same type are encapsulated in one
##              Mysqlx.Connection.Compression
##
## * GROUP - it corresponds to
##           server_combine_mixed_messages=TRUE,
##           server_max_combine_messages=UNSET|0
##           In this configuration multiple X Protocol messages
##           of different types are encapsulated in one
##           Mysqlx.Connection.Compression
##
## Cases where "server_max_combine_message" has values grater than 1
## are in separate test file: compression_limit_message_count.test
##

--echo
--echo ## A. Execute the test using zlib/group
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=deflate_stream
  --compression-combine-mixed-messages=1
  --compression-max-combine-messages=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## B. Execute the test using zlib/multiple
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=deflate_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## C. Execute the test using zlib/single
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=deflate_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=1
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## D. Execute the test using lz4/group
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=lz4_message
  --compression-combine-mixed-messages=1
  --compression-max-combine-messages=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## E. Execute the test using lz4/multiple
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=lz4_message
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## F. Execute the test using lz4/single
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=lz4_message
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=1
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## G. Execute the test using zstd/group
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=zstd_stream
  --compression-combine-mixed-messages=1
  --compression-max-combine-messages=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## H. Execute the test using zstd/multiple
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=zstd_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## I. Execute the test using zstd/single
--echo #

CALL recreate_tables();
exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=zstd_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=1
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;

## Cleanup
DROP SCHEMA IF EXISTS xtest;
--remove_files_wildcard $MYSQL_TMP_DIR *.xpl
--source include/xplugin_drop_user.inc
